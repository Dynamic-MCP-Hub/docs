---
title: "API Backend"
description: "FastAPI-based REST service for data operations and business logic"
---

The API Backend is a FastAPI-based REST service that handles all data operations, authentication, and business logic for the Sari Platform.

## Project Structure

```
mcp-backend/
├── main.py                     # Application entry point
├── requirements.txt            # Python dependencies
├── config/
│   ├── __init__.py
│   ├── database.py             # PostgreSQL connection
│   └── gcp_database.py         # GCP services (Redis, Secrets)
├── auth/
│   ├── firebase_auth.py        # Firebase token verification
│   └── dual_auth.py            # Dual auth (Firebase + API Key)
├── routes/
│   ├── profiles.py             # User management
│   ├── collections.py          # API collection CRUD
│   ├── access_control.py       # Client access grants
│   ├── audit.py                # Audit logging
│   ├── rate_limits.py          # Rate limit configuration
│   └── vector_search.py        # Semantic search
├── services/
│   ├── email.py                # Email notifications (Resend)
│   ├── embeddings.py           # Vertex AI embeddings
│   ├── vector_sync.py          # Vector synchronization
│   └── rate_limit_publisher.py # Pub/Sub events
└── migrations/                 # SQL migration scripts
```

## Application Initialization

The application initializes with a lifespan context manager:

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    initialize_database()
    initialize_firebase()
    initialize_vertex_ai()
    yield
    # Shutdown
    close_database()
```

## Route Registration

| Prefix | Router | Description |
|--------|--------|-------------|
| `/api/profiles` | profiles.py | User profile management |
| `/api/collections` | collections.py | API collection CRUD |
| `/api/audit` | audit.py | Audit log operations |
| `/api/access` | access_control.py | Access control |
| `/api/rate-limits` | rate_limits.py | Rate limiting |
| `/api/vector` | vector_search.py | Semantic search |

## Database Layer

### Connection Management

The `Database` class manages a single persistent connection using Cloud SQL Connector:

```python
class Database:
    def _connect(self):
        connector = Connector()
        conn = connector.connect(
            instance_connection_name,
            "pg8000",
            user=db_user,
            password=db_password,
            db=db_name,
            ip_type=IPTypes.PRIVATE
        )
```

### Query Methods

| Method | Purpose | Returns |
|--------|---------|---------|
| `query(sql, params)` | SELECT multiple rows | `List[Dict]` |
| `query_one(sql, params)` | SELECT single row | `Dict` or `None` |
| `execute(sql, params)` | INSERT/UPDATE/DELETE | Row count |
| `test_connection()` | Verify connection | `bool` |

## Services

### Email Service

Uses Resend API for transactional emails:

```python
def send_approval_email(to_email, full_name, company_name, client_id, client_secret):
    resend.Emails.send({
        "from": RESEND_FROM_EMAIL,
        "to": to_email,
        "subject": "Your API Access Has Been Approved",
        "html": html_content
    })
```

### Embeddings Service

Generates vector embeddings using Vertex AI:

```python
MODEL_NAME = "text-embedding-004"
EMBEDDING_DIMENSIONS = 768

def generate_embedding(text: str) -> List[float]:
    model = TextEmbeddingModel.from_pretrained(MODEL_NAME)
    embeddings = model.get_embeddings([text])
    return embeddings[0].values  # 768-dimensional vector
```

### Vector Sync Service

Synchronizes collection embeddings:

```python
async def sync_collection_vector(collection_id, collection_name, description):
    embedding = generate_collection_embedding(collection_name, description)
    vector_str = "[" + ",".join(map(str, embedding)) + "]"

    execute("""
        INSERT INTO "Vector_Collections" (id, collection_name, collection_desc_embedding)
        VALUES (%s, %s, %s::vector)
        ON CONFLICT (id) DO UPDATE SET
            collection_name = EXCLUDED.collection_name,
            collection_desc_embedding = EXCLUDED.collection_desc_embedding
    """, (collection_id, collection_name, vector_str))
```

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| fastapi | 0.109.0 | Web framework |
| uvicorn | 0.27.0 | ASGI server |
| pg8000 | 1.30.5 | PostgreSQL driver |
| cloud-sql-python-connector | 1.7.0 | Cloud SQL connection |
| firebase-admin | 6.0.0 | Firebase Auth |
| redis | 5.0.1 | Caching |
| google-cloud-aiplatform | 1.43.0 | Vertex AI |
| google-cloud-pubsub | 2.18.4 | Pub/Sub |
| resend | 0.8.0 | Email service |
| bcrypt | 4.1.2 | Password hashing |

## Error Handling

Standard HTTP error responses:

```python
from fastapi import HTTPException

# Authentication error
raise HTTPException(status_code=401, detail="Invalid token")

# Authorization error
raise HTTPException(status_code=403, detail="Admin access required")

# Not found
raise HTTPException(status_code=404, detail="Collection not found")

# Conflict
raise HTTPException(status_code=409, detail="Client already has access")
```

## Local Development

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Set environment variables
export CLOUD_SQL_CONNECTION_NAME=project:region:instance
export DB_NAME=sari_db
export DB_USER=app_user

# Run server
uvicorn main:app --reload --port 8080
```

## Health Check

```http
GET /health
```

**Response:**
```json
{
  "status": "healthy",
  "service": "mcp-backend"
}
```
