---
title: "Database"
description: "PostgreSQL schema with pgvector for semantic search"
---

The Sari Platform uses PostgreSQL (Cloud SQL) with the pgvector extension for semantic search capabilities.

## Database Configuration

| Setting | Value |
|---------|-------|
| Engine | PostgreSQL 15+ |
| Hosting | Google Cloud SQL |
| Connection | Cloud SQL Connector (Private IP) |
| Driver | pg8000 |
| Extension | pgvector |

## Schema Overview

```
┌────────────────┐       ┌─────────────────────┐
│    profiles    │◀──────│ firebase_user_mapping│
└───────┬────────┘       └─────────────────────┘
        │
        │ 1:N
        ▼
┌────────────────┐       ┌─────────────────────┐
│client_api_access│─────▶│   api_collections    │
└────────────────┘       └──────────┬──────────┘
                                    │
                                    │ 1:1
                                    ▼
                         ┌─────────────────────┐
                         │ Vector_Collections  │
                         └─────────────────────┘

┌────────────────┐       ┌─────────────────────┐
│  audit_logs    │       │  rate_limit_tiers   │
└────────────────┘       └─────────────────────┘

                         ┌─────────────────────────┐
                         │client_rate_limit_overrides│
                         └─────────────────────────┘
```

## Tables

### profiles

Stores user account information.

```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    full_name VARCHAR(255) NOT NULL,
    company_name VARCHAR(255),
    role VARCHAR(50) NOT NULL DEFAULT 'client',
    registration_status VARCHAR(50) NOT NULL DEFAULT 'pending',
    client_id VARCHAR(100) UNIQUE,
    client_secret TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    approved_at TIMESTAMP WITH TIME ZONE,
    approved_by UUID REFERENCES profiles(id)
);

CREATE INDEX idx_profiles_email ON profiles(email);
CREATE INDEX idx_profiles_client_id ON profiles(client_id);
CREATE INDEX idx_profiles_role ON profiles(role);
CREATE INDEX idx_profiles_status ON profiles(registration_status);
```

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| email | VARCHAR(255) | User email (unique) |
| full_name | VARCHAR(255) | Display name |
| company_name | VARCHAR(255) | Organization name |
| role | VARCHAR(50) | `admin` or `client` |
| registration_status | VARCHAR(50) | `pending`, `approved`, `rejected` |
| client_id | VARCHAR(100) | API client identifier |
| client_secret | TEXT | bcrypt hashed API secret |

### firebase_user_mapping

Links Firebase UIDs to profile records.

```sql
CREATE TABLE firebase_user_mapping (
    firebase_uid VARCHAR(128) PRIMARY KEY,
    profile_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_firebase_mapping_profile ON firebase_user_mapping(profile_id);
```

### api_collections

Stores API collection metadata and OpenAPI specifications.

```sql
CREATE TABLE api_collections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    openapi_spec JSONB,
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_collections_name ON api_collections(name);
CREATE INDEX idx_collections_created_by ON api_collections(created_by);
```

### client_api_access

Access control matrix linking clients to collections.

```sql
CREATE TABLE client_api_access (
    client_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    api_collection_id UUID NOT NULL REFERENCES api_collections(id) ON DELETE CASCADE,
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    granted_by UUID REFERENCES profiles(id),
    PRIMARY KEY (client_id, api_collection_id)
);

CREATE INDEX idx_access_client ON client_api_access(client_id);
CREATE INDEX idx_access_collection ON client_api_access(api_collection_id);
```

### audit_logs

System activity logging.

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_message ON audit_logs USING GIN (message);
```

**Example message structure:**
```json
{
  "level": "info",
  "action": "api_call",
  "client_id": "client_abc123",
  "collection_id": "uuid-here",
  "method": "GET",
  "endpoint": "/users",
  "status_code": 200,
  "duration_ms": 150
}
```

### Vector_Collections

Stores vector embeddings for semantic search.

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE "Vector_Collections" (
    id UUID PRIMARY KEY,
    collection_name VARCHAR(255) NOT NULL,
    collection_desc_embedding vector(768),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- HNSW index for fast similarity search
CREATE INDEX idx_vector_embedding ON "Vector_Collections"
    USING hnsw (collection_desc_embedding vector_cosine_ops);
```

**Vector Operations:**
```sql
-- Cosine similarity search
SELECT
    id,
    collection_name,
    1 - (collection_desc_embedding <=> query_vector) / 2 as similarity
FROM "Vector_Collections"
ORDER BY collection_desc_embedding <=> query_vector
LIMIT 10;
```

### rate_limit_tiers

Rate limit configuration by tier.

```sql
CREATE TABLE rate_limit_tiers (
    tier VARCHAR(50) PRIMARY KEY,
    allowed_limit INTEGER NOT NULL,
    window_seconds INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### client_rate_limit_overrides

Per-client rate limit overrides.

```sql
CREATE TABLE client_rate_limit_overrides (
    id SERIAL PRIMARY KEY,
    client_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    allowed_limit INTEGER NOT NULL,
    window_seconds INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_overrides_client ON client_rate_limit_overrides(client_id);
```

## Common Queries

### Get user profile with Firebase UID

```sql
SELECT p.*
FROM profiles p
JOIN firebase_user_mapping fum ON p.id = fum.profile_id
WHERE fum.firebase_uid = $1;
```

### List collections accessible to a client

```sql
SELECT ac.*
FROM api_collections ac
JOIN client_api_access caa ON ac.id = caa.api_collection_id
JOIN profiles p ON caa.client_id = p.id
WHERE p.client_id = $1
  AND p.registration_status = 'approved';
```

### Vector similarity search (client filtered)

```sql
SELECT
    vc.id,
    vc.collection_name,
    1 - (vc.collection_desc_embedding <=> $1::vector) / 2 as similarity
FROM "Vector_Collections" vc
JOIN api_collections ac ON vc.id = ac.id
JOIN client_api_access caa ON ac.id = caa.api_collection_id
JOIN profiles p ON caa.client_id = p.id
WHERE p.client_id = $2
  AND p.registration_status = 'approved'
ORDER BY similarity DESC
LIMIT $3;
```

### Get effective rate limit for client

```sql
-- Check for active override first
SELECT 'override' as source, allowed_limit, window_seconds, id as config_id
FROM client_rate_limit_overrides
WHERE client_id = (SELECT id FROM profiles WHERE client_id = $1)
  AND is_active = true
LIMIT 1

UNION ALL

-- Fall back to tier config
SELECT 'tier' as source, allowed_limit, window_seconds, NULL as config_id
FROM rate_limit_tiers
WHERE tier = 'client' AND is_active = true
LIMIT 1;
```

## Connection Configuration

```python
from google.cloud.sql.connector import Connector, IPTypes

def _connect():
    connector = Connector()
    conn = connector.connect(
        os.environ["CLOUD_SQL_CONNECTION_NAME"],
        "pg8000",
        user=os.environ["DB_USER"],
        password=gcp_config.get_secret("db-password"),
        db=os.environ["DB_NAME"],
        ip_type=IPTypes.PRIVATE
    )
    return conn
```

## Index Summary

| Table | Index | Type | Columns |
|-------|-------|------|---------|
| profiles | idx_profiles_email | B-tree | email |
| profiles | idx_profiles_client_id | B-tree | client_id |
| profiles | idx_profiles_role | B-tree | role |
| firebase_user_mapping | idx_firebase_mapping_profile | B-tree | profile_id |
| api_collections | idx_collections_name | B-tree | name |
| client_api_access | idx_access_client | B-tree | client_id |
| client_api_access | idx_access_collection | B-tree | api_collection_id |
| audit_logs | idx_audit_timestamp | B-tree | timestamp DESC |
| audit_logs | idx_audit_message | GIN | message |
| Vector_Collections | idx_vector_embedding | HNSW | collection_desc_embedding |
